# 図書館システム設計書（仮）

---

## 目的
現在、蔵書データをExcelで管理しており、不必要に業務時間がかかっていたり、ヒューマンエラーが発生しているので、システムを導入して改善する。

---

## 範囲
- 対象: 図書の予約、貸出、返却、利用者管理、司書用管理機能
- 対象外（初期）: 細かなUIデザインの最終決定、外部通知（SMS等）はメールのみで実装検討

---

## 用語定義
- 司書: 管理者権限を持つ利用者
- 利用者: 書籍を借りる一般ユーザ
- 予約者: 利用者のうち、予約機能を使用するユーザ
- 蔵書: 個別に管理される書籍単位（同じ書籍タイトルでも複数の蔵書IDあり）
- 貸し出し不可: ある書籍が全て他の利用者に貸し出されているまたは、予約されている状態

---

## 要約（システム概要）
- Web ベースの管理・利用ポータル。
- 司書はログインして蔵書管理・利用者管理が可能。利用者はカウンターで貸出・予約を行うための情報を入力する（またはセルフ端末を利用）。
- 要件: PBKDF2 を用いたパスワード保護、二段階認証（司書）、TLS、稼働率99.9%目標、1千万冊規模のスケーラビリティ。

---

## 機能設計（主な機能）
1. 司書ログイン（パスワードまたはバーコード、二段階認証）
2. 蔵書管理（一覧、検索、状態表示、蔵書ID生成）
3. 貸出処理（貸出可否判定、貸出登録、返却予定日表示）
4. 返却処理（返却登録、予約者通知、延滞処理）
5. 予約処理（予約登録、返却時の通知）
6. 利用者管理（登録、変更、ステータス更新）
7. 履歴管理（貸出・返却・予約履歴）

---

## 非機能要件（要件参照）
- 可用性: 営業時間中の稼働率99.9%
- 性能: 検索/ログイン応答 1秒以下、蔵書1千万件に対するスケーラビリティ
- 運用: 毎日閉館後に増分バックアップ、毎月最初の閉館後にフルバックアップ
- 保持: 履歴を過去3年保持
- セキュリティ: TLS、PBKDF2、セッション自動タイムアウト15分、2要素認証（メール）

---

## 業務ルール定義
### 貸し出しルール
- 利用者は同時に５冊まで本を貸し出せる
- 貸し出し期間は２週間とする
### 予約ルール
- 予約者は一冊まで同時に本を予約できる
- 予約中の蔵書は、予約者以外には貸し出し不可とする
- 予約期限は予約者が貸し出し可能になってから１週間とする
- 貸し出し不可だった場合のみ予約可能とする
### 利用者ルール
- 返却期限を過ぎた場合、注意フラグを立てる
- 次回、貸し出し時に注意画面を表示しフラグを下げてから通常通り貸し出し処理を行う

---

## アーキテクチャ（概要） 🔧
- レイヤ: Web UI (React等) / API (ASP.NET Core推奨: 要件にPBKDF2の記載あり) / RDBMS (PostgreSQL推奨)
- 認証: JWT またはセッションクッキー＋二段階認証（メール）
- 配置案: Webサーバ × N、APIサーバ × M、DBはマスター/リードレプリカ、ロードバランサ、バックアップストレージ

> ※ 技術はプロジェクト要件・運用方針で最終決定してください。

---

## データ設計（要点）
- ER図は`ER/liblaly_ER図.png`を参照。

主要テーブル（サンプル）:

- `users`（利用者）
  - user_id PK
  - name
  - birth_date
  - gender
  - caution_flag
  - current_loan_count

- `books`（書籍管理: 書籍タイトル単位）
  - book_master_id PK
  - title
  - author
  - publisher
  - genre

- `copies`（蔵書：個別ID）
  - copy_id PK
  - book_master_id FK -> `books`
  - status (available/loaned/reserved)

- `lending_histories`（貸し出し・予約履歴）
  - history_id PK
  - user_id FK
  - copy_id FK
  - lend_date
  - expected_return_date
  - status (貸出中/返却済/予約中)
  - actual_return_date

- `librarians`（司書）
  - librarian_id PK
  - email
  - password_hash (PBKDF2)
  - name

インデックス: 検索対象のカラム（title, author, status, user_id）に適切なインデックスを付与

---

## 状態遷移
|状態名|状態内容|
| AVAILABLE | 貸出可 |
| CHECKED_OUT | 貸し出し中 |
| ON_HOLD | 取置中 |

- 状態遷移は`liblaly_状態遷移図.png`を参照。

---

## API設計（抜粋）
API設計（抜粋・修正版）
- POST /api/auth/login — 利用者・司書ログイン（認証トークン発行、ロール情報含む）
- POST /api/auth/2fa/verify — 二段階認証検証（※仕様のみ、実装は任意）
- GET /api/books — 書籍一覧取得（検索フィルタ）
- GET /api/copies — 蔵書一覧取得（状態：AVAILABLE / CHECKED_OUT / ON_HOLD）
- POST /api/copies/{id}/checkout — 蔵書貸出（司書操作）
- POST /api/copies/{id}/return — 蔵書返却（司書操作）
- POST /api/copies/{id}/reserve — 蔵書予約（利用者操作）
- GET /api/me — 自身の利用状況取得（貸出中一覧・予約一覧）
- GET /api/users/{id} — 利用者情報取得（司書操作）
認証・認可:
- 利用者・司書は共通の認証方式を使用する
- API操作は認証必須
- 操作可能なAPIはロール（利用者／司書）により制御する
- API通信はTLSを前提とする

---

## 画面設計（要点）
- 司書画面: ログイン、メインメニュー、蔵書管理、貸出処理画面、返却処理画面、利用者管理画面
- 利用者向け: 予約受付画面（カウンター入力用シンプルUI）
- 画面遷移図: `画面遷移/` のdrawioを参照

---

## ユースケース（抜粋）
- 利用者が蔵書を持ち来て貸出: 受付→貸出可否判定→貸出登録→返却予定日表示
- 返却: 返却入力→予約状態であれば取り置き表示・通知→利用者ステータス更新
- 予約: 予約登録→返却後予約者へメール通知

---

## シーケンス例（簡易）
1. 貸出
   - 司書ログイン→蔵書検索→貸出登録API呼出→貸出成功→蔵書状態更新
2. 返却
   - 返却入力→貸出情報確認→返却登録→予約者がいれば通知→利用者延滞チェック

---

## テスト方針
- 単体テスト: ビジネスロジック（貸出可否、延滞判定等）
- 結合テスト: API→DBの基本フロー
- E2E: ログイン→貸出→返却→履歴確認
- 負荷テスト: 検索負荷、同時アクセス、応答時間が要求を満たすこと

---

## 運用・バックアップ
- 毎日閉館後に増分バックアップ、月一回フルバックアップ（要件通り）
- 監視: アプリヘルス、DB容量、レスポンス時間、エラーレートを監視
- 復旧目標: 発生日中に復旧

---

## データ移行
- 既存Excelからカラムマッピング→CSVエクスポート→インポートスクリプトで正規化して登録
- テスト移行をステージ環境で実施後、本番移行を実施

---

## セキュリティ要点
- パスワード: PBKDF2 でハッシュ保存
- 通信: TLS 必須
- セッション: 15分無操作で自動ログアウト
- 個人情報（利用者名・生年月日等）はアクセス制御および別テーブル分離

---

## 添付参照図
- ER図: `ER/liblaly_ER図.png`
- ユースケース図: `ユースケース図/liblaly_ユースケース図.png`
- 画面遷移図/モック: `画面遷移/` フォルダ内
- 状態遷移図: `liblaly_状態遷移図.png`を参照。

---

## 今後の課題・TODO
1. 各APIの詳細仕様（パラメータ、レスポンス例）をOpenAPI形式で作成
2. 画面モックの詳細化（操作フロー）
3. バックアップ・監視の具体的構成を決定
4. Excel移行スクリプトの設計とテスト
